# NixOS Development Specifics

## The Path Problem

In NixOS, binaries are stored in `/nix/store/` with unique hashes:
```
/nix/store/l107fmp3bj88fq80ag7qymr5pppvj031-rust-default-1.92.0-beta.4-2025-12-05/bin/rust-analyzer
```

These paths **change** when:
- Running `nix flake update` — updates flake.lock, new package versions
- Modifying `flake.nix` — changes to dependencies or configuration
- Updating package versions — new hash in store path
- Running `nix-collect-garbage -d` — removes unused store paths, may delete tools installed via previous `nix develop` sessions
- Running `nix store gc` — same effect as garbage collection
- System rebuild with `nixos-rebuild switch` — may clean up old generations

This breaks IDE/tool configurations that require absolute paths.

## Our Solution: Generated Configs

Following NixOS philosophy of **declarative configuration generation**, we generate config files at shell entry time with current paths.

### Implementation in `scripts/dev-setup.sh`

```bash
# Calculate hash of current tool paths + versions
current_hash=$(echo "$ra_info:$slint_info:$nixd_info" | sha256sum | cut -d' ' -f1)

# Regenerate configs if paths changed
if [ "$current_hash" != "$stored_hash" ]; then
  # Generate .zed/settings.json with current LSP paths
  # Generate .mcp.json with current PATH for Serena
fi
```

### Generated Files (in .gitignore)
- `.zed/settings.json` — Zed editor LSP configuration
- `.zed/.lsp-hash` — Hash for change detection
- `.mcp.json` — Serena MCP configuration with PATH

### Static Files (in git)
- `flake.nix` — Nix development environment definition
- `scripts/dev-setup.sh` — Config generation script

## Why This Approach?

1. **Portability** — Each developer gets correct paths for their system
2. **Automation** — No manual path updates needed
3. **NixOS-native** — Follows the same pattern as NixOS itself (generate configs from declarations)
4. **Cross-platform** — Works on NixOS, macOS, regular Linux

## Tools Affected

| Tool | Problem | Solution |
|------|---------|----------|
| Zed LSP | Needs absolute paths to LSP servers | Generate `.zed/settings.json` |
| Serena MCP | Requires rustup, uvx isolates PATH | Local venv + `scripts/rustup` shim |
| slint-lsp | Installed via cargo, path is stable | `~/.cargo/bin/slint-lsp` (no issue) |

## MCP Servers Integration

### The Problem with Claude Code + NixOS

Claude Code doesn't expand `$PATH` in `.mcp.json` env vars. Combined with NixOS's volatile store paths, we need a different approach.

### Solution: Wrapper Scripts with Embedded Paths

Instead of setting `env.PATH` in `.mcp.json`, we use wrapper scripts that embed nix store paths directly:

```
scripts/
├── serena-mcp      # Generated by dev-setup.sh, embeds current nix paths
├── context7-mcp    # Fetches API key from rbw, runs npx
├── github-mcp      # Fetches token from rbw, runs npx
└── rustup          # Shim for Serena's rustup dependency
```

### Serena MCP

Serena requires `rustup which rust-analyzer`, but NixOS doesn't use rustup.

**rustup shim** (`scripts/rustup`):
```bash
rustup which rust-analyzer  # → returns $(which rust-analyzer) from nix
rustup --version            # → returns "rustup-shim 1.0.0"
```

**serena-mcp wrapper** (generated by `dev-setup.sh`):
```bash
#!/usr/bin/env bash
export PATH="$SCRIPT_DIR:/nix/store/...-rust-.../bin:/nix/store/...-coreutils-.../bin:..."
exec "$PROJECT_DIR/.venv/bin/serena" "$@"
```

The wrapper is regenerated when LSP paths change (detected via hash comparison).

### Context7 & GitHub MCP (Secrets via Bitwarden)

These wrappers fetch secrets from Bitwarden CLI (`rbw`) at runtime:

```bash
# scripts/context7-mcp
export CONTEXT7_API_KEY="$(rbw get context7)"
exec npx -y @upstash/context7-mcp@latest "$@"

# scripts/github-mcp  
export GITHUB_PERSONAL_ACCESS_TOKEN="$(rbw get github_personal_access_token)"
exec npx -y @modelcontextprotocol/server-github "$@"
```

**Why rbw?** Secrets never touch the repo — fetched at runtime from encrypted vault.

### Generated vs Static Files

| File | Generated? | Purpose |
|------|------------|---------|
| `scripts/serena-mcp` | ✅ Yes | Wrapper with embedded nix paths |
| `scripts/context7-mcp` | ❌ No | Static, fetches secret from rbw |
| `scripts/github-mcp` | ❌ No | Static, fetches secret from rbw |
| `scripts/rustup` | ❌ No | Static rustup shim |
| `.mcp.json` | ✅ Yes | Points to wrapper scripts |
| `.venv/` | ✅ Yes | Python venv with Serena |

### Local Serena Installation

Instead of `uvx` (which isolates PATH), we install Serena locally:
- `.venv/` — Python venv with Serena installed
- `dev-setup.sh` — creates venv and installs Serena automatically
- `~/.serena/serena_config.yml` — global Serena config with rust-analyzer path

## Dynamic Linking Issues

NixOS doesn't have `/lib64/ld-linux-x86-64.so.2`. Downloaded binaries (from Zed extensions, etc.) fail with:
```
Could not start dynamically linked executable
```

### Solutions:
1. **nix-ld** — System-wide, enables running any dynamically linked binary
2. **Explicit paths in config** — What we do for LSP servers
3. **cargo install** — Builds from source with Nix libraries (works)

## Developer Onboarding

New developers on NixOS need to:
1. Have `nix` with flakes enabled
2. Run `nix develop` before any work
3. Launch IDE from within `nix develop` session
4. (Optional) Enable `programs.nix-ld.enable = true` for downloaded binaries
